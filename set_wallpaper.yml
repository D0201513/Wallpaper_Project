---
- name: 🪟 Set Windows Wallpaper via Scheduled Task
  hosts: windows
  gather_facts: false
  vars:
    wallpaper_path: 'C:\\Users\\Public\\Pictures\\wallpaper.png'
    script_path: 'C:\\Users\\Public\\set-wallpaper.ps1'

  tasks:
    - name: 📄 Copy wallpaper image to Windows
      win_copy:
        src: wallpaper.png
        dest: "{{ wallpaper_path }}"

    - name: 📝 Create PowerShell script to set wallpaper
      win_copy:
        dest: "{{ script_path }}"
        content: |
          Add-Type @"
          using System.Runtime.InteropServices;
          public class Wallpaper {
              [DllImport("user32.dll", SetLastError = true)]
              public static extern bool SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
          }
"@
          [Wallpaper]::SystemParametersInfo(20, 0, '{{ wallpaper_path }}', 3)

    - name: 🗓️ Create scheduled task to apply the wallpaper
      win_scheduled_task:
        name: "SetWallpaperTask"
        description: "Set desktop wallpaper"
        actions:
          - path: powershell.exe
            arguments: "-ExecutionPolicy Bypass -File \"{{ script_path }}\""
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        run_level: highest
        state: present
        enabled: yes
        trigger:
          - type: once
            start_boundary: "{{ '%Y-%m-%dT%H:%M:%S' | strftime(ansible_date_time.epoch | int + 60) }}"
        execution_time_limit: PT5M

    - name: ▶️ Run the scheduled task immediately
      win_command: schtasks /run /tn SetWallpaperTask
